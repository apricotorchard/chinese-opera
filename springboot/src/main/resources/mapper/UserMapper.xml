<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.springboot.mapper.UserMapper">

    <!-- 结果映射，确保 User 对象中的 roles 也能正确映射 -->
    <resultMap id="UserRoleMap" type="com.example.springboot.domain.User">
        <id property="id" column="id"/>
        <result property="userName" column="user_name"/>
        <result property="nickName" column="nick_name"/>
        <result property="password" column="password"/>
        <result property="type" column="type"/>
        <result property="status" column="status"/>
        <result property="email" column="email"/>
        <result property="phonenumber" column="phonenumber"/>
        <result property="sex" column="sex"/>
        <result property="avatar" column="avatar"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="delFlag" column="del_flag"/>

        <!-- 处理用户和角色的多对多关系 -->
        <collection property="roles" ofType="com.example.springboot.domain.Role">
            <id property="id" column="role_id"/>
            <result property="roleName" column="role_name"/>
            <result property="roleKey" column="role_key"/>
            <result property="roleSort" column="role_sort"/>
            <result property="dataScope" column="data_scope"/>
            <result property="status" column="role_status"/>
            <result property="delFlag" column="role_del_flag"/>
            <result property="createBy" column="role_create_by"/>
            <result property="createTime" column="role_create_time"/>
            <result property="updateBy" column="role_update_by"/>
            <result property="updateTime" column="role_update_time"/>
            <result property="remark" column="role_remark"/>
        </collection>
    </resultMap>

    <!-- 查询所有用户及其角色 -->
    <select id="getAllUsersWithRoles" resultMap="UserRoleMap">
        SELECT
            u.*,
            r.id AS role_id, r.role_name, r.role_key, r.role_sort, r.data_scope,
            r.status AS role_status, r.del_flag AS role_del_flag,
            r.create_by AS role_create_by, r.create_time AS role_create_time,
            r.update_by AS role_update_by, r.update_time AS role_update_time,
            r.remark AS role_remark
        FROM sys_user u
                 LEFT JOIN sys_user_role ur ON u.id = ur.user_id
                 LEFT JOIN sys_role r ON ur.role_id = r.id
    </select>

</mapper>

